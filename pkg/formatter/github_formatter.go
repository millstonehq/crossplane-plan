package formatter

import (
	"fmt"
	"strings"

	"github.com/millstonehq/crossplane-plan/pkg/differ"
	"k8s.io/apimachinery/pkg/apis/meta/v1/unstructured"
)

// GitHubFormatter formats diffs for GitHub PR comments
type GitHubFormatter struct{}

// NewGitHubFormatter creates a new GitHubFormatter
func NewGitHubFormatter() *GitHubFormatter {
	return &GitHubFormatter{}
}

// FormatDiff formats a diff result as a GitHub-flavored markdown comment
func (f *GitHubFormatter) FormatDiff(xr *unstructured.Unstructured, result *differ.DiffResult) string {
	var b strings.Builder

	// Header
	b.WriteString("## üîÑ Crossplane Preview\n\n")
	
	// XR information
	b.WriteString(fmt.Sprintf("**Resource:** `%s/%s`\n", xr.GetKind(), xr.GetName()))
	if xr.GetNamespace() != "" {
		b.WriteString(fmt.Sprintf("**Namespace:** `%s`\n", xr.GetNamespace()))
	}
	b.WriteString("\n")

	// Summary
	if !result.HasChanges {
		b.WriteString("### ‚úÖ No Changes\n\n")
		b.WriteString("This PR will not modify any infrastructure resources.\n\n")
		// Footer
		b.WriteString("---\n")
		b.WriteString("_Generated by [crossplane-plan](https://github.com/millstonehq/crossplane-plan)_\n")
		return b.String()
	}

	// Changes detected
	b.WriteString("### üìã Changes Detected\n\n")
	b.WriteString(result.Summary)
	b.WriteString("\n\n")

	// Diff output
	b.WriteString("<details>\n")
	b.WriteString("<summary>üìù View Full Diff</summary>\n\n")
	b.WriteString("```diff\n")
	b.WriteString(result.RawDiff)
	b.WriteString("\n```\n")
	b.WriteString("</details>\n\n")

	// Footer
	b.WriteString("---\n")
	b.WriteString("_Generated by [crossplane-plan](https://github.com/millstonehq/crossplane-plan)_\n")

	return b.String()
}

// FormatMultipleDiffs formats multiple XR diffs into a single comment
func (f *GitHubFormatter) FormatMultipleDiffs(results map[string]*differ.DiffResult) string {
	var b strings.Builder

	// Header
	b.WriteString("## üîÑ Crossplane Preview\n\n")

	// Count total changes
	totalChanges := 0
	totalResources := len(results)
	for _, result := range results {
		if result.HasChanges {
			totalChanges++
		}
	}

	// Summary
	b.WriteString(fmt.Sprintf("**Resources:** %d total, %d with changes\n\n", totalResources, totalChanges))

	if totalChanges == 0 {
		b.WriteString("### ‚úÖ No Changes\n\n")
		b.WriteString("This PR will not modify any infrastructure resources.\n")
		return b.String()
	}

	// List resources with changes
	b.WriteString("### üìã Resources with Changes\n\n")
	for name, result := range results {
		if result.HasChanges {
			b.WriteString(fmt.Sprintf("- **%s**: %s\n", name, result.Summary))
		}
	}
	b.WriteString("\n")

	// Individual diffs
	for name, result := range results {
		if !result.HasChanges {
			continue
		}

		b.WriteString(fmt.Sprintf("### `%s`\n\n", name))
		b.WriteString("<details>\n")
		b.WriteString("<summary>üìù View Diff</summary>\n\n")
		b.WriteString("```diff\n")
		b.WriteString(result.RawDiff)
		b.WriteString("\n```\n")
		b.WriteString("</details>\n\n")
	}

	// Footer
	b.WriteString("---\n")
	b.WriteString("_Generated by [crossplane-plan](https://github.com/millstonehq/crossplane-plan)_\n")

	return b.String()
}
